<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux Browser</title>
    <style>
        :root {
            --bg: #121212;
            --fg: #e0e0e0;
            --font: 'Courier New', monospace;
            --accent-secure: #00ff41; /* Цвет хакеров */
            --accent-unsafe: #888;    /* Серый цвет */
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ФОНОВАЯ МАТРИЦА --- */
        canvas#matrixCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; /* На заднем плане */
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none;
        }
        
        /* Видна только когда класс secure-mode активен */
        body.secure-mode canvas#matrixCanvas {
            opacity: 0.3; /* Полупрозрачная, чтобы читать текст сайта */
        }

        /* --- ИНТЕРФЕЙС --- */
        .toolbar {
            height: 60px;
            background: #000;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
            z-index: 100; /* Поверх матрицы */
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .logo {
            font-weight: bold;
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin-right: 10px;
        }

        .url-bar-container {
            flex-grow: 1;
            position: relative;
        }

        .url-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            font-family: var(--font);
            font-size: 1rem;
            transition: 0.3s;
        }

        /* Индикация режима в строке поиска */
        body.secure-mode .url-input {
            border-color: var(--accent-secure);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
            color: var(--accent-secure);
        }

        button.btn {
            background: transparent;
            border: 1px solid #444;
            color: #aaa;
            padding: 8px 15px;
            cursor: pointer;
            font-family: var(--font);
            text-transform: uppercase;
            font-size: 0.8rem;
            border-radius: 4px;
            transition: 0.3s;
        }

        button.btn:hover { border-color: #fff; color: #fff; }

        /* Кнопка защиты */
        button#protectBtn {
            border: 1px solid var(--accent-unsafe);
            color: var(--accent-unsafe);
            font-weight: bold;
            min-width: 140px;
        }

        body.secure-mode button#protectBtn {
            border-color: var(--accent-secure);
            color: var(--accent-secure);
            background: rgba(0, 255, 65, 0.1);
            text-shadow: 0 0 5px var(--accent-secure);
        }

        /* --- ОКНО ПРОСМОТРА --- */
        .viewport-container {
            flex-grow: 1;
            position: relative;
            z-index: 50;
            background: #fff; /* Белый фон для сайтов */
        }

        iframe#viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Сообщение об ошибке (если сайт не грузится без защиты) */
        .error-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #111;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            display: none; /* Скрыто по умолчанию */
        }
    </style>
</head>
<body>

    <canvas id="matrixCanvas"></canvas>

    <div class="toolbar">
        <div class="logo">FLUX</div>
        
        <button class="btn" onclick="window.history.back()">←</button>
        
        <div class="url-bar-container">
            <input type="text" class="url-input" id="urlInput" placeholder="Введите 'вк' или URL..." autocomplete="off">
        </div>
        
        <button class="btn" onclick="navigate()">GO</button>
        <button class="btn" id="protectBtn" onclick="toggleProtection()">ЗАЩИТА: OFF</button>
    </div>

    <div class="viewport-container">
        <iframe id="viewer" src=""></iframe>
        
        <div class="error-overlay" id="errorOverlay">
            <h2>Сайт не открывается?</h2>
            <p>Этот сайт блокирует обычный просмотр.</p>
            <p>Включите <b>ЗАЩИТУ</b>, чтобы использовать прокси-обход.</p>
        </div>
    </div>

    <script>
        // --- ПЕРЕМЕННЫЕ ---
        let isSecure = false; // По умолчанию защита выключена (прямое соединение)
        const viewer = document.getElementById('viewer');
        const urlInput = document.getElementById('urlInput');
        const protectBtn = document.getElementById('protectBtn');
        const errorOverlay = document.getElementById('errorOverlay');

        // Быстрые ссылки
        const SHORTCUTS = {
            'вк': 'vk.com',
            'vk': 'vk.com',
            'ютуб': 'youtube.com',
            'гугл': 'google.com',
            'яндекс': 'ya.ru'
        };

        // --- ЛОГИКА ПЕРЕХОДА ---
        function navigate() {
            let val = urlInput.value.trim().toLowerCase();
            if (!val) return;

            // Скрываем ошибку при новой попытке
            errorOverlay.style.display = 'none';

            // 1. Обработка быстрых команд (вк -> vk.com)
            if (SHORTCUTS[val]) val = SHORTCUTS[val];

            // 2. Определяем, это URL или поиск
            let targetUrl = '';
            if ((val.includes('.') && !val.includes(' ')) || val.startsWith('http')) {
                // Это ссылка
                targetUrl = val.startsWith('http') ? val : `https://${val}`;
            } else {
                // Это поисковый запрос (всегда используем DuckDuckGo)
                targetUrl = `https://duckduckgo.com/?q=${encodeURIComponent(val)}`;
            }

            // 3. ГЛАВНАЯ ЛОГИКА ЗАЩИТЫ
            if (isSecure) {
                // ЗАЩИТА ВКЛ: Используем наш API прокси
                console.log("Secure Mode: Proxying via Vercel");
                viewer.src = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
            } else {
                // ЗАЩИТА ВЫКЛ: Прямое подключение (браузер -> сайт)
                console.log("Unsafe Mode: Direct connection");
                viewer.src = targetUrl;
                
                // Таймер: если через 2 секунды ничего не изменилось, возможно, сайт заблокировал iframe
                // Это просто визуальная подсказка, реальный статус iframe прочитать нельзя из-за CORS
                setTimeout(() => {
                    // Показываем подсказку пользователю
                    // (Можно убрать, если мешает)
                }, 2000);
            }
        }

        // Обработка Enter
        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') navigate();
        });


        // --- ЛОГИКА ЗАЩИТЫ (ВКЛ/ВЫКЛ) ---
        function toggleProtection() {
            isSecure = !isSecure;

            if (isSecure) {
                // Включаем визуализацию
                document.body.classList.add('secure-mode');
                protectBtn.textContent = "ЗАЩИТА: ON";
                startMatrix();
                
                // Если в строке уже есть сайт, перезагружаем его через защиту
                if (urlInput.value) navigate();
            } else {
                // Выключаем
                document.body.classList.remove('secure-mode');
                protectBtn.textContent = "ЗАЩИТА: OFF";
                stopMatrix();
                
                // Если сайт открыт, перезагружаем его напрямую (может сломаться, если сайт имеет защиту X-Frame)
                if (urlInput.value) navigate();
            }
        }


        // --- МАТРИЦА (АНИМАЦИЯ) ---
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        let matrixInterval;
        const chars = "#%&"; // Твои символы

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.ceil(columns)).fill(1);

        function drawMatrix() {
            // Очищаем чуть-чуть для следа
            ctx.fillStyle = 'rgba(18, 18, 18, 0.1)'; // Цвет фона (темный)
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ffffff'; // БЕЛЫЙ ЦВЕТ СИМВОЛОВ
            ctx.font = fontSize + 'px Courier New';

            for (let i = 0; i < drops.length; i++) {
                const text = chars.charAt(Math.floor(Math.random() * chars.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        function startMatrix() {
            if (matrixInterval) clearInterval(matrixInterval);
            matrixInterval = setInterval(drawMatrix, 50);
        }

        function stopMatrix() {
            clearInterval(matrixInterval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        window.onresize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };

    </script>
</body>
</html>
